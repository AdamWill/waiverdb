# Template to produce a new OpenShift pipeline job for triggering a build on repotracker messages
#
---
apiVersion: v1
kind: Template
metadata:
  name: waiverdb-greenwave-trigger
labels:
  template: waiverdb-greenwave-trigger
parameters:
- name: NAME
  displayName: Short unique identifier for the templated instances
  description: This field is used to deploy multiple pipelines to one OpenShift project from this template.
  value: waiverdb-greenwave-trigger
- name: WAIVERDB_GIT_REPO
  displayName: WaiverDB Git repo URL
  description: Default WaiverDB Git repo URL in which to run dev tests against
  value: "https://pagure.io/waiverdb.git"
- name: WAIVERDB_GIT_REF
  displayName: WaiverDB Git repo ref
  description: Default WaiverDB Git repo ref in which to run dev tests against
  value: master
- name: DECISION_CONTEXT_REGEX
  displayName: Regex pattern for Greenwave decision context in CI message
  required: true
- name: SUBJECT_IDENTIFIER_REGEX
  displayName: Regex pattern for Greenwave subject identifier in CI message
  value: ^factory2/waiverdb@
- name: SOURCE_CONTAINER_REPO
  displayName: Container repo of the image
  value: quay.io/factory2/waiverdb
- name: TARGET_TAG
  displayName: Tag name to promote the image to
  required: true
- name: IMAGE_PROMOTION_JOB
  displayName: Downstream image promotion job to trigger
- name: MESSAGING_PROVIDER
  displayName: Name of the JMS messaging provider
  value: Red Hat UMB
- name: MESSAGING_TOPIC
  displayName: Name of the topic that the trigger subscribes to
  value: "Consumer.rh-jenkins-ci-plugin.c3i-greenwave-trigger.VirtualTopic.eng.greenwave.decision.update"
- name: JENKINS_AGENT_IMAGE
  displayName: Container image for Jenkins slave pods
  value: docker-registry.engineering.redhat.com/factory2/waiverdb-jenkins-slave:latest
- name: OPENSHIFT_CLOUD_NAME
  displayName: Name of OpenShift cloud in Jenkins master configuration
  value: openshift
objects:
- kind: ServiceAccount
  apiVersion: v1
  metadata:
    name: "${NAME}-jenkins-slave"
    labels:
      app: "${NAME}"
- kind: RoleBinding
  apiVersion: v1
  metadata:
    name: "${NAME}-jenkins-slave_edit"
    labels:
      app: "${NAME}"
  subjects:
  - kind: ServiceAccount
    name: "${NAME}-jenkins-slave"
  roleRef:
    name: edit
- kind: "BuildConfig"
  apiVersion: "v1"
  metadata:
    name: "${NAME}"
    labels:
      app: "${NAME}"
  spec:
    runPolicy: "Serial"
    completionDeadlineSeconds: 1800
    source:
      git:
        uri: "${WAIVERDB_GIT_REPO}"
        ref: "${WAIVERDB_GIT_REF}"
    strategy:
      type: JenkinsPipeline
      jenkinsPipelineStrategy:
        env:
        - name: WAIVERDB_GIT_REPO
          value: "${WAIVERDB_GIT_REPO}"
        - name: WAIVERDB_GIT_REF
          value: "${WAIVERDB_GIT_REF}"
        - name: OPENSHIFT_CLOUD_NAME
          value: "${OPENSHIFT_CLOUD_NAME}"
        - name: JENKINS_AGENT_IMAGE
          value:  "${JENKINS_AGENT_IMAGE}"
        - name: JENKINS_AGENT_SERVICE_ACCOUNT
          value: "${NAME}-jenkins-slave"
        - name: SOURCE_CONTAINER_REPO
          value: "${SOURCE_CONTAINER_REPO}"
        - name: TARGET_TAG
          value: "${TARGET_TAG}"
        - name: IMAGE_PROMOTION_JOB
          value: "${IMAGE_PROMOTION_JOB}"
        - name: DECISION_CONTEXT_REGEX
          value: "${DECISION_CONTEXT_REGEX}"
        - name: SUBJECT_IDENTIFIER_REGEX
          value: "${SUBJECT_IDENTIFIER_REGEX}"
        - name: MESSAGING_PROVIDER
          value: "${MESSAGING_PROVIDER}"
        - name: MESSAGING_TOPIC
          value: "${MESSAGING_TOPIC}"
        # CI_MESSAGE and MESSAGE_HEADERS are used internally by JMS messaging plugin
        - name: CI_MESSAGE
          value:
        - name: MESSAGE_HEADERS
          value:
        jenkinsfilePath: openshift/pipelines/templates/waiverdb-greenwave-trigger.Jenkinsfile

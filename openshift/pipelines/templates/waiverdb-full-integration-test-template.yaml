# Template to produce a new OpenShift pipeline for running integration tests
#
---
apiVersion: v1
kind: Template
metadata:
  name: waiverdb-full-integration-test
labels:
  template: waiverdb-full-integration-test
parameters:
- name: NAME
  displayName: Short unique identifier for the templated instances
  description: This field is used to deploy multiple pipelines to one OpenShift project from this template.
  required: true
  value: waiverdb-full-integration-test
- name: PIPELINEAAS_PROJECT
  displayName: OpenShift project of pipeline-as-a-Service jobs
  value: "c3i"
- name: IMAGE
  displayName: The container image to be tested
  description: This field must be in repo:tag or repo@sha256 format
  value: quay.io/factory2/waiverdb:latest
- name: WAIVERDB_GIT_REPO
  displayName: WaiverDB Git repo URL
  description: Default WaiverDB Git repo URL in which to run functional tests against
  required: true
  value: "https://pagure.io/waiverdb.git"
- name: WAIVERDB_GIT_REF
  displayName: WaiverDB Git repo ref
  description: Default WaiverDB Git repo ref in which to run functional tests against
  required: true
  value: master
- name: JENKINS_AGENT_IMAGE
  displayName: Container image for Jenkins slave pods
  required: true
  value: docker-registry.upshift.redhat.com/factory2/waiverdb-jenkins-slave:latest
- name: CONTAINER_REGISTRY_CREDENTIALS
  displayName: Secret name of container registries used for pulling and pushing images
  value: factory2-pipeline-registry-credentials
  required: false
- name: JENKINS_AGENT_CLOUD_NAME
  displayName: Name of OpenShift cloud in Jenkins master configuration
  required: true
  value: openshift
- name: ENVIRONMENT
  displayName: environment name (dev/stage/prod)
  required: true
  value: stage
- name: MESSAGING_PROVIDER
  displayName: Name of the JMS messaging provider
  value: Red Hat UMB
- name: BACKEND_INTEGRATION_TEST_REPO
  displayName: backend integration test repo
  required: true
  value: https://gitlab.cee.redhat.com/devops/factory2-segment-tests.git
- name: BACKEND_INTEGRATION_TEST_REPO_BRANCH
  displayName: backend integration test repo
  required: true
  value: master
- name: BACKEND_INTEGRATION_TEST_FILE
  displayName: backend integration test file
  required: true
  value: greenwave-segment-test/greenwave-segment-test-c3i.sh
- name: NO_CLEANUP_AFTER_TEST
  displayName: Keep environment after test
  value: "false"
- name: MAIL_ADDRESS
  displayName: If set, build failure messages to this mail address.
{% include "snippets/c3i-library-parameters.yaml" %}
objects:
- kind: ServiceAccount
  apiVersion: v1
  metadata:
    name: "${NAME}-jenkins-slave"
    labels:
      app: "${NAME}"
- kind: RoleBinding
  apiVersion: v1
  metadata:
    name: "${NAME}-jenkins-slave_edit"
    labels:
      app: "${NAME}"
  subjects:
  - kind: ServiceAccount
    name: "${NAME}-jenkins-slave"
  roleRef:
    name: edit
- kind: "BuildConfig"
  apiVersion: "v1"
  metadata:
    name: "${NAME}"
    labels:
      app: "${NAME}"
  spec:
    runPolicy: "Parallel"
    completionDeadlineSeconds: 1800
    source:
      git:
        uri: "${WAIVERDB_GIT_REPO}"
        ref: "${WAIVERDB_GIT_REF}"
    strategy:
      type: JenkinsPipeline
      jenkinsPipelineStrategy:
        env:
        - name: "WAIVERDB_GIT_REPO"
          value: "${WAIVERDB_GIT_REPO}"
        - name: "WAIVERDB_GIT_REF"
          value: "${WAIVERDB_GIT_REF}"
        - name: "IMAGE"
          value: "${IMAGE}"
        - name: IMAGE_IS_SCRATCH
          value: "true"
        - name: "CONTAINER_REGISTRY_CREDENTIALS"
          value: "${CONTAINER_REGISTRY_CREDENTIALS}"
        - name: "TEST_ID"
          value: ""
        - name: "PIPELINEAAS_PROJECT"
          value: "${PIPELINEAAS_PROJECT}"
        - name: JENKINS_AGENT_IMAGE
          value: "${JENKINS_AGENT_IMAGE}"
        - name: JENKINS_AGENT_CLOUD_NAME
          value: "${JENKINS_AGENT_CLOUD_NAME}"
        - name: JENKINS_AGENT_SERVICE_ACCOUNT
          value: "${NAME}-jenkins-slave"
        - name: "NO_CLEANUP_AFTER_TEST"
          value: "${NO_CLEANUP_AFTER_TEST}"
        - name: ENVIRONMENT
          value: "${ENVIRONMENT}"
        - name:  MAIL_ADDRESS
          value: "{MAIL_ADDRESS}"
        - name: MESSAGING_PROVIDER
          value: "${MESSAGING_PROVIDER}"
        - name: BACKEND_INTEGRATION_TEST_REPO
          value: "${BACKEND_INTEGRATION_TEST_REPO}"
        - name: BACKEND_INTEGRATION_TEST_REPO_BRANCH
          value: "${BACKEND_INTEGRATION_TEST_REPO_BRANCH}"
        - name: BACKEND_INTEGRATION_TEST_FILE
          value: "${BACKEND_INTEGRATION_TEST_FILE}"
        jenkinsfilePath: openshift/pipelines/templates/waiverdb-full-integration-test.Jenkinsfile
